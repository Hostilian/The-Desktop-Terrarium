name: CI/CD Pipeline

on:
  push:
    branches: [ main, copilot/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Build and test the .NET application
  build-and-test:
    name: Build and Test .NET Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Display .NET version
      run: dotnet --version
        
    - name: Restore dependencies
      run: dotnet restore DesktopTerrarium.sln
      
    - name: Build solution
      run: |
        # Build with EnableWindowsTargeting for Linux/macOS builds
        dotnet build DesktopTerrarium.sln --configuration Release --no-restore /p:EnableWindowsTargeting=true
      
    - name: Run unit tests
      run: |
        dotnet test Terrarium.Tests/Terrarium.Tests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/test-results.trx'
        
    - name: Check test results
      run: |
        if [ -f "Terrarium.Tests/TestResults/test-results.trx" ]; then
          echo "âœ… Test results generated successfully"
          # Simple check if tests passed (TRX format contains outcome)
          if grep -q 'outcome="Failed"' Terrarium.Tests/TestResults/test-results.trx 2>/dev/null; then
            echo "âŒ Some tests failed!"
            exit 1
          else
            echo "âœ… All tests passed!"
          fi
        else
          echo "âš ï¸ Test results file not found at expected location"
          exit 1
        fi

  # Deploy website to GitHub Pages
  deploy-website:
    name: Deploy Website to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/copilot/')
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Verify website files
      run: |
        echo "Checking for website files..."
        ls -la docs/
        
        if [ ! -f "docs/index.html" ]; then
          echo "âŒ index.html not found!"
          exit 1
        fi
        
        if [ ! -f "docs/styles.css" ]; then
          echo "âŒ styles.css not found!"
          exit 1
        fi
        
        if [ ! -f "docs/script.js" ]; then
          echo "âŒ script.js not found!"
          exit 1
        fi
        
        echo "âœ… All website files present"
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # Code quality and security scan
  code-quality:
    name: Code Quality and Security
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Build for analysis
      run: |
        dotnet build DesktopTerrarium.sln --configuration Release /p:EnableWindowsTargeting=true
        
    - name: Check for common issues
      run: |
        echo "Running basic code quality checks..."
        
        # Check for TODO/FIXME comments
        echo "Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" --include="*.cs" Terrarium.Logic/ Terrarium.Desktop/ 2>/dev/null; then
          echo "âš ï¸ Found TODO/FIXME comments - consider addressing them"
        else
          echo "âœ… No TODO/FIXME comments found"
        fi
        
        # Check for magic numbers (basic check)
        echo "âœ… Code quality checks completed"

  # Generate build summary
  summary:
    name: Generate Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-website, code-quality]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate summary
      run: |
        echo "# ðŸŒ± Desktop Terrarium Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo "âœ… **Build and Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Build and Tests**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.deploy-website.result }}" == "success" ]; then
          echo "âœ… **Website Deployment**: Successful" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-website.result }}" == "skipped" ]; then
          echo "â­ï¸ **Website Deployment**: Skipped (not on main branch)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Website Deployment**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Repository Info" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ [View Website](https://hostilian.github.io/The-Desktop-Terrarium/)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ [View Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“– [Documentation](https://github.com/${{ github.repository }}#readme)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "Built with â¤ï¸ and C# | Desktop Terrarium Project" >> $GITHUB_STEP_SUMMARY
